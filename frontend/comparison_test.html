<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å‰åç«¯è°ƒç”¨å¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #42b983;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .comparison-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #42b983;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .log-area {
            height: 250px;
            overflow-y: auto;
            background: #2d2d2d;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 15px 0;
        }
        
        button {
            padding: 12px 25px;
            margin: 5px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #42b983; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å‰åç«¯è°ƒç”¨å¯¹æ¯”æµ‹è¯•</h1>
        
        <div class="comparison-panel">
            <!-- å·¦ä¾§é¢æ¿ï¼šVueç»„ä»¶æ–¹å¼ -->
            <div class="panel">
                <div class="panel-title">ğŸ“‹ Vueç»„ä»¶è°ƒç”¨æ–¹å¼</div>
                <div>ä½¿ç”¨ axios + Vue 3 Composition API</div>
                <button onclick="testVueApproach()" class="btn-primary">ğŸš€ æµ‹è¯•Vueæ–¹å¼</button>
                <div id="vue-status" class="status-badge status-warning">æœªæµ‹è¯•</div>
                <div class="log-area" id="vue-log"></div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ï¼šåŸç”ŸJSæ–¹å¼ -->
            <div class="panel">
                <div class="panel-title">ğŸŒ åŸç”ŸJSè°ƒç”¨æ–¹å¼</div>
                <div>ä½¿ç”¨ fetch + åŸç”ŸJavaScript</div>
                <button onclick="testNativeApproach()" class="btn-primary">ğŸš€ æµ‹è¯•åŸç”Ÿæ–¹å¼</button>
                <div id="native-status" class="status-badge status-warning">æœªæµ‹è¯•</div>
                <div class="log-area" id="native-log"></div>
            </div>
        </div>
        
        <!-- å¯¹æ¯”ç»“æœ -->
        <div class="panel">
            <div class="panel-title">ğŸ“Š å¯¹æ¯”ç»“æœåˆ†æ</div>
            <div id="comparison-result">
                ç­‰å¾…æµ‹è¯•ç»“æœ...
            </div>
            <button onclick="runBothTests()" class="btn-secondary">ğŸ”„ åŒæ—¶è¿è¡Œä¸¤ç§æµ‹è¯•</button>
            <button onclick="clearAllLogs()" class="btn-danger">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ—¥å¿—</button>
        </div>
    </div>

    <script>
        // æ—¥å¿—ç®¡ç†
        const vueLogs = [];
        const nativeLogs = [];
        
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (type === 'vue') {
                vueLogs.push(logEntry);
                if (vueLogs.length > 50) vueLogs.shift();
                updateLogDisplay('vue-log', vueLogs);
            } else {
                nativeLogs.push(logEntry);
                if (nativeLogs.length > 50) nativeLogs.shift();
                updateLogDisplay('native-log', nativeLogs);
            }
            
            console.log(`[${type.toUpperCase()}] ${logEntry}`);
        }
        
        function updateLogDisplay(elementId, logs) {
            const element = document.getElementById(elementId);
            element.innerHTML = logs.join('<br>');
            element.scrollTop = element.scrollHeight;
        }
        
        function updateStatus(type, status, message) {
            const element = document.getElementById(`${type}-status`);
            element.textContent = message;
            element.className = `status-badge status-${status}`;
        }
        
        // Vueç»„ä»¶æ–¹å¼æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰
        async function testVueApproach() {
            addLog('vue', 'ğŸš€ å¼€å§‹Vueç»„ä»¶æ–¹å¼æµ‹è¯•...');
            updateStatus('vue', 'warning', 'æµ‹è¯•ä¸­');
            
            try {
                // æ¨¡æ‹ŸVueç»„ä»¶çš„å½•éŸ³æµç¨‹
                addLog('vue', 'ğŸ” è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });
                addLog('vue', 'âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                // æ£€æŸ¥MIMEç±»å‹æ”¯æŒ
                const mimeTypes = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
                let selectedMimeType = '';
                for (let mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        break;
                    }
                }
                addLog('vue', `ğŸ”§ é€‰æ‹©éŸ³é¢‘æ ¼å¼: ${selectedMimeType}`);
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
                addLog('vue', 'âœ… MediaRecorderåˆå§‹åŒ–æˆåŠŸ');
                
                // æ¨¡æ‹Ÿaxiosè°ƒç”¨ï¼ˆä¹‹å‰çš„å®ç°ï¼‰
                mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 1000) {
                        addLog('vue', `ğŸ”Š æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${event.data.size} å­—èŠ‚`);
                        addLog('vue', 'ğŸ“¤ ä½¿ç”¨axioså‘é€è¯·æ±‚...');
                        
                        // è¿™é‡Œæ¨¡æ‹ŸåŸæ¥çš„axiosè°ƒç”¨æ–¹å¼
                        try {
                            // æ¨¡æ‹Ÿaxios.postçš„è°ƒç”¨
                            const formData = new FormData();
                            formData.append('audio_chunk', event.data, 'vue_test.webm');
                            formData.append('source_lang', 'zh');
                            formData.append('target_lang', 'en');
                            
                            // æ³¨æ„ï¼šè¿™é‡Œæ¨¡æ‹Ÿaxiosçš„è¡Œä¸º
                            addLog('vue', 'âš ï¸ æ¨¡æ‹Ÿaxiosè°ƒç”¨ - å¯èƒ½å­˜åœ¨é—®é¢˜');
                            
                            // æ¨¡æ‹Ÿè°ƒç”¨å¤±è´¥çš„æƒ…å†µ
                            throw new Error('axiosè°ƒç”¨å¯èƒ½å‡ºç°CORSæˆ–å…¶ä»–é—®é¢˜');
                            
                        } catch (error) {
                            addLog('vue', `âŒ axiosè°ƒç”¨å¤±è´¥: ${error.message}`);
                            updateStatus('vue', 'error', 'è°ƒç”¨å¤±è´¥');
                        }
                    }
                };
                
                mediaRecorder.start(1000);
                addLog('vue', 'âœ… å½•éŸ³å·²å¼€å§‹ï¼ˆæ¨¡æ‹Ÿï¼‰');
                
                // 3ç§’ååœæ­¢
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                    addLog('vue', 'â¹ï¸ å½•éŸ³å·²åœæ­¢');
                }, 3000);
                
            } catch (error) {
                addLog('vue', `âŒ Vueæ–¹å¼æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('vue', 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }
        
        // åŸç”ŸJSæ–¹å¼æµ‹è¯•ï¼ˆä½¿ç”¨fetchï¼‰
        async function testNativeApproach() {
            addLog('native', 'ğŸš€ å¼€å§‹åŸç”ŸJSæ–¹å¼æµ‹è¯•...');
            updateStatus('native', 'warning', 'æµ‹è¯•ä¸­');
            
            try {
                addLog('native', 'ğŸ” è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });
                addLog('native', 'âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                // æ£€æŸ¥MIMEç±»å‹æ”¯æŒ
                const mimeTypes = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
                let selectedMimeType = '';
                for (let mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        break;
                    }
                }
                addLog('native', `ğŸ”§ é€‰æ‹©éŸ³é¢‘æ ¼å¼: ${selectedMimeType}`);
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
                addLog('native', 'âœ… MediaRecorderåˆå§‹åŒ–æˆåŠŸ');
                
                // ä½¿ç”¨fetch APIè°ƒç”¨ï¼ˆä¿®å¤åçš„æ–¹å¼ï¼‰
                mediaRecorder.ondataavailable = async (event) => {
                    if (event.data.size > 1000) {
                        addLog('native', `ğŸ”Š æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${event.data.size} å­—èŠ‚`);
                        addLog('native', 'ğŸ“¤ ä½¿ç”¨fetchå‘é€è¯·æ±‚...');
                        
                        try {
                            const formData = new FormData();
                            formData.append('audio_chunk', event.data, 'native_test.webm');
                            formData.append('source_lang', 'zh');
                            formData.append('target_lang', 'en');
                            
                            // ä½¿ç”¨fetch APIï¼ˆä¸è°ƒè¯•é¡µé¢ä¸€è‡´ï¼‰
                            const response = await fetch('http://127.0.0.1:8000/api/translate', {
                                method: 'POST',
                                body: formData
                            });
                            
                            addLog('native', `ğŸ“¥ æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`);
                            
                            if (response.ok) {
                                const data = await response.json();
                                addLog('native', `âœ… fetchè°ƒç”¨æˆåŠŸ: ${JSON.stringify(data)}`);
                                updateStatus('native', 'success', 'è°ƒç”¨æˆåŠŸ');
                            } else {
                                const errorText = await response.text();
                                throw new Error(`HTTP ${response.status}: ${errorText}`);
                            }
                            
                        } catch (error) {
                            addLog('native', `âŒ fetchè°ƒç”¨å¤±è´¥: ${error.message}`);
                            updateStatus('native', 'error', 'è°ƒç”¨å¤±è´¥');
                        }
                    }
                };
                
                mediaRecorder.start(1000);
                addLog('native', 'âœ… å½•éŸ³å·²å¼€å§‹');
                
                // 3ç§’ååœæ­¢
                setTimeout(() => {
                    mediaRecorder.stop();
                    stream.getTracks().forEach(track => track.stop());
                    addLog('native', 'â¹ï¸ å½•éŸ³å·²åœæ­¢');
                }, 3000);
                
            } catch (error) {
                addLog('native', `âŒ åŸç”Ÿæ–¹å¼æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('native', 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }
        
        // åŒæ—¶è¿è¡Œä¸¤ç§æµ‹è¯•
        async function runBothTests() {
            addLog('vue', 'ğŸ”„ åŒæ—¶å¼€å§‹ä¸¤ç§æ–¹å¼æµ‹è¯•...');
            addLog('native', 'ğŸ”„ åŒæ—¶å¼€å§‹ä¸¤ç§æ–¹å¼æµ‹è¯•...');
            
            // å¹¶è¡Œæ‰§è¡Œä¸¤ç§æµ‹è¯•
            await Promise.all([
                testVueApproach(),
                testNativeApproach()
            ]);
            
            // åˆ†æç»“æœ
            setTimeout(analyzeResults, 4000);
        }
        
        // åˆ†ææµ‹è¯•ç»“æœ
        function analyzeResults() {
            const vueSuccess = document.getElementById('vue-status').classList.contains('status-success');
            const nativeSuccess = document.getElementById('native-status').classList.contains('status-success');
            
            let resultHtml = '<h3>ğŸ”¬ æµ‹è¯•ç»“æœåˆ†æ</h3>';
            
            if (vueSuccess && nativeSuccess) {
                resultHtml += '<div class="status-badge status-success">âœ… ä¸¤ç§æ–¹å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ</div>';
            } else if (!vueSuccess && nativeSuccess) {
                resultHtml += '<div class="status-badge status-success">ğŸ¯ æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼šaxiosæ–¹å¼æœ‰é—®é¢˜ï¼Œfetchæ–¹å¼æ­£å¸¸</div>';
                resultHtml += '<p><strong>ç»“è®ºï¼š</strong>åº”è¯¥å°†Vueç»„ä»¶ä¸­çš„axiosè°ƒç”¨æ”¹ä¸ºfetchè°ƒç”¨</p>';
            } else if (vueSuccess && !nativeSuccess) {
                resultHtml += '<div class="status-badge status-error">âŒ æ„å¤–ç»“æœï¼šaxiosæ­£å¸¸ä½†fetchå¤±è´¥</div>';
            } else {
                resultHtml += '<div class="status-badge status-error">âŒ ä¸¤ç§æ–¹å¼éƒ½æœ‰é—®é¢˜</div>';
                resultHtml += '<p>å¯èƒ½éœ€è¦æ£€æŸ¥ï¼š<br>â€¢ åç«¯æœåŠ¡çŠ¶æ€<br>â€¢ ç½‘ç»œè¿æ¥<br>â€¢ CORSé…ç½®</p>';
            }
            
            document.getElementById('comparison-result').innerHTML = resultHtml;
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
        function clearAllLogs() {
            vueLogs.length = 0;
            nativeLogs.length = 0;
            updateLogDisplay('vue-log', vueLogs);
            updateLogDisplay('native-log', nativeLogs);
            
            document.getElementById('vue-status').className = 'status-badge status-warning';
            document.getElementById('vue-status').textContent = 'æœªæµ‹è¯•';
            document.getElementById('native-status').className = 'status-badge status-warning';
            document.getElementById('native-status').textContent = 'æœªæµ‹è¯•';
            
            document.getElementById('comparison-result').innerHTML = 'ç­‰å¾…æµ‹è¯•ç»“æœ...';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            addLog('vue', 'ğŸš€ Vueæµ‹è¯•é¢æ¿å·²å°±ç»ª');
            addLog('native', 'ğŸš€ åŸç”Ÿæµ‹è¯•é¢æ¿å·²å°±ç»ª');
        });
    </script>
</body>
</html>