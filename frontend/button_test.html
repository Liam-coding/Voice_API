<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ™ï¸ æŒ‰é’®ç»‘å®šç»ˆææµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #42b983;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .log-area {
            height: 300px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 20px 0;
        }
        
        .btn-test {
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            background: #42b983;
            color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(66, 185, 131, 0.3);
            margin: 10px;
        }
        
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(66, 185, 131, 0.4);
        }
        
        .btn-stop {
            background: #dc3545;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .btn-stop:hover {
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
        }
        
        .test-section {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .result-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ æŒ‰é’®ç»‘å®šç»ˆææµ‹è¯•</h1>
        
        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
            <div><strong>å½•éŸ³çŠ¶æ€:</strong> <span id="recording-status">âšª æœªå½•éŸ³</span></div>
            <div><strong>ç‚¹å‡»æ¬¡æ•°:</strong> <span id="click-count">0</span></div>
            <div><strong>æœ€åç‚¹å‡»:</strong> <span id="last-click">ä»æœªç‚¹å‡»</span></div>
        </div>
        
        <!-- ä¸»è¦æµ‹è¯•æŒ‰é’® -->
        <div style="text-align: center; margin: 30px 0;">
            <button id="main-button" class="btn-test">
                â–¶ï¸ å¼€å§‹å½•éŸ³æµ‹è¯•
            </button>
        </div>
        
        <!-- æ—¥å¿—æ˜¾ç¤º -->
        <div>
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div id="log-area" class="log-area"></div>
            <div style="text-align: center;">
                <button onclick="clearLogs()" style="padding: 8px 15px; margin: 5px;">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="testAllFunctions()" style="padding: 8px 15px; margin: 5px;">ğŸ”„ å…¨é¢æµ‹è¯•</button>
            </div>
        </div>
        
        <!-- åŠŸèƒ½æµ‹è¯•åŒº -->
        <div class="test-section">
            <h2>ğŸ”§ åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testButtonEvent()" class="btn-test">ğŸ–±ï¸ æµ‹è¯•æŒ‰é’®äº‹ä»¶</button>
            <button onclick="testConsole()" class="btn-test">ğŸ–¥ï¸ æµ‹è¯•æ§åˆ¶å°è¾“å‡º</button>
            <button onclick="testNetwork()" class="btn-test">ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <button onclick="testRecording()" class="btn-test">ğŸ¤ æµ‹è¯•å½•éŸ³åŠŸèƒ½</button>
            
            <div class="result-box">
                <div><strong>æŒ‰é’®äº‹ä»¶æµ‹è¯•:</strong> <span id="button-test-result">æœªæµ‹è¯•</span></div>
                <div><strong>æ§åˆ¶å°æµ‹è¯•:</strong> <span id="console-test-result">æœªæµ‹è¯•</span></div>
                <div><strong>ç½‘ç»œè¿æ¥:</strong> <span id="network-test-result">æœªæµ‹è¯•</span></div>
                <div><strong>å½•éŸ³åŠŸèƒ½:</strong> <span id="recording-test-result">æœªæµ‹è¯•</span></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isRecording = false;
        let clickCount = 0;
        let mediaRecorder = null;
        let logEntries = [];
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            // æ·»åŠ åˆ°æ•°ç»„
            logEntries.push(logEntry);
            if (logEntries.length > 100) {
                logEntries.shift();
            }
            
            // æ›´æ–°æ˜¾ç¤º
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = logEntries.join('<br>');
            logArea.scrollTop = logArea.scrollHeight;
            
            // è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(logEntry);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logEntries = [];
            document.getElementById('log-area').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            document.getElementById('recording-status').textContent = 
                isRecording ? 'ğŸ”´ å½•éŸ³ä¸­' : 'âšª æœªå½•éŸ³';
            document.getElementById('click-count').textContent = clickCount;
            document.getElementById('last-click').textContent = new Date().toLocaleTimeString();
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—å’Œæ ·å¼
            const button = document.getElementById('main-button');
            if (isRecording) {
                button.innerHTML = 'â¹ï¸ åœæ­¢å½•éŸ³æµ‹è¯•';
                button.className = 'btn-test btn-stop';
            } else {
                button.innerHTML = 'â–¶ï¸ å¼€å§‹å½•éŸ³æµ‹è¯•';
                button.className = 'btn-test';
            }
        }
        
        // ä¸»æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('main-button').addEventListener('click', function() {
            clickCount++;
            addLog(`ğŸ–±ï¸ ä¸»æŒ‰é’®è¢«ç‚¹å‡»! (ç¬¬${clickCount}æ¬¡)`);
            addLog(`å½“å‰å½•éŸ³çŠ¶æ€: ${isRecording ? 'å½•éŸ³ä¸­' : 'æœªå½•éŸ³'}`);
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
        
        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            addLog('ğŸ™ï¸ å¼€å§‹å½•éŸ³æµ‹è¯•...');
            
            try {
                addLog('ğŸ” è¯·æ±‚éº¦å…‹é£æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                addLog('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                addLog('ğŸ”§ åˆå§‹åŒ–MediaRecorder...');
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                addLog('âœ… MediaRecorderåˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        addLog(`ğŸ”Š æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${event.data.size} å­—èŠ‚`);
                        
                        // æµ‹è¯•å‘é€åˆ°åç«¯
                        if (event.data.size > 1000) {
                            testSendAudio(event.data);
                        }
                    }
                };
                
                mediaRecorder.onstop = function() {
                    addLog('â¹ï¸ MediaRecorderå·²åœæ­¢');
                };
                
                mediaRecorder.onerror = function(event) {
                    addLog(`âŒ MediaRecorderé”™è¯¯: ${event.error}`);
                };
                
                // å¼€å§‹å½•éŸ³ï¼Œæ¯ç§’è·å–æ•°æ®
                mediaRecorder.start(1000);
                isRecording = true;
                updateStatus();
                addLog('âœ… å½•éŸ³å·²å¼€å§‹');
                
                // 5ç§’åè‡ªåŠ¨åœæ­¢
                setTimeout(function() {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 5000);
                
            } catch (error) {
                addLog(`âŒ å½•éŸ³å¯åŠ¨å¤±è´¥: ${error.message}`);
                alert(`å½•éŸ³å¯åŠ¨å¤±è´¥:\n${error.message}`);
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            addLog('â¹ï¸ åœæ­¢å½•éŸ³...');
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            isRecording = false;
            updateStatus();
            addLog('âœ… å½•éŸ³å·²åœæ­¢');
        }
        
        // æµ‹è¯•å‘é€éŸ³é¢‘
        async function testSendAudio(audioBlob) {
            addLog(`ğŸ“¤ æµ‹è¯•å‘é€éŸ³é¢‘æ•°æ®... (${audioBlob.size} å­—èŠ‚)`);
            
            const formData = new FormData();
            formData.append('audio_chunk', audioBlob, 'test.webm');
            formData.append('source_lang', 'zh');
            formData.append('target_lang', 'en');
            
            try {
                addLog('ğŸŒ å‘é€è¯·æ±‚åˆ°åç«¯...');
                const response = await fetch('http://127.0.0.1:8000/api/translate', {
                    method: 'POST',
                    body: formData
                });
                
                addLog(`ğŸ“¥ æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`âœ… APIè°ƒç”¨æˆåŠŸ: ${JSON.stringify(data)}`);
                } else {
                    const errorText = await response.text();
                    addLog(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                addLog(`ğŸ’¥ ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // å„é¡¹æµ‹è¯•å‡½æ•°
        function testButtonEvent() {
            addLog('ğŸ–±ï¸ æµ‹è¯•æŒ‰é’®äº‹ä»¶ç»‘å®š...');
            document.getElementById('button-test-result').textContent = 'âœ… äº‹ä»¶ç»‘å®šæ­£å¸¸';
            addLog('âœ… æŒ‰é’®äº‹ä»¶æµ‹è¯•é€šè¿‡');
        }
        
        function testConsole() {
            addLog('ğŸ–¥ï¸ æµ‹è¯•æ§åˆ¶å°è¾“å‡º...');
            console.log('è¿™æ˜¯æ¥è‡ªæµ‹è¯•çš„æ§åˆ¶å°æ¶ˆæ¯');
            console.error('è¿™æ˜¯é”™è¯¯æ¶ˆæ¯æµ‹è¯•');
            console.warn('è¿™æ˜¯è­¦å‘Šæ¶ˆæ¯æµ‹è¯•');
            document.getElementById('console-test-result').textContent = 'âœ… æ§åˆ¶å°è¾“å‡ºæ­£å¸¸';
            addLog('âœ… æ§åˆ¶å°æµ‹è¯•é€šè¿‡');
        }
        
        async function testNetwork() {
            addLog('ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥...');
            try {
                const response = await fetch('http://127.0.0.1:8000/health');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('network-test-result').textContent = `âœ… è¿æ¥æˆåŠŸ (${response.status})`;
                    addLog(`âœ… ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡: ${JSON.stringify(data)}`);
                } else {
                    document.getElementById('network-test-result').textContent = `âŒ è¿æ¥å¤±è´¥ (${response.status})`;
                    addLog(`âŒ ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                document.getElementById('network-test-result').textContent = `ğŸ’¥ è¿æ¥å¼‚å¸¸: ${error.message}`;
                addLog(`ğŸ’¥ ç½‘ç»œè¿æ¥æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function testRecording() {
            addLog('ğŸ¤ æµ‹è¯•å½•éŸ³åŠŸèƒ½...');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('recording-test-result').textContent = 'âœ… å½•éŸ³åŠŸèƒ½æ­£å¸¸';
                addLog('âœ… å½•éŸ³åŠŸèƒ½æµ‹è¯•é€šè¿‡');
            } catch (error) {
                document.getElementById('recording-test-result').textContent = `âŒ å½•éŸ³å¤±è´¥: ${error.message}`;
                addLog(`âŒ å½•éŸ³åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        function testAllFunctions() {
            addLog('ğŸ”„ å¼€å§‹å…¨é¢åŠŸèƒ½æµ‹è¯•...');
            testButtonEvent();
            testConsole();
            testNetwork();
            testRecording();
            addLog('ğŸ å…¨é¢æµ‹è¯•å®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            addLog('ğŸš€ æŒ‰é’®ç»‘å®šæµ‹è¯•é¡µé¢å·²åŠ è½½');
            addLog('ğŸ’¡ è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
            updateStatus();
        });
    </script>
</body>
</html>